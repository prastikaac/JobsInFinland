<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>See User Details</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: 1100px;
      margin: 20px auto;
      padding: 20px;
      border-radius: 10px;
    }

    h1 {
      text-align: center;
      color: #333;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }

    th,
    td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }

    th {
      background-color: #f2f2f2;
    }

    button {
      background-color: #4CAF50;
      color: white;
      padding: 8px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    button:hover {
      background-color: #45a049;
    }

    button.delete {
      background-color: #f44336;
    }

    button.delete:hover {
      background-color: #da190b;
    }

    button.copy {
      background-color: #2196F3;
    }

    button.copy:hover {
      background-color: #0b7dda;
    }

    .copy-icon {
      vertical-align: middle;
      margin-left: 5px;
    }

    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }

    .error-message {
      color: red;
      margin-top: 5px;
    }

    .course-section {
      margin-bottom: 20px;
    }

    .course-details {
      margin-bottom: 20px;
    }

    a {
      text-decoration: none;
      color: #2196F3;
    }

    a:hover {
      text-decoration: underline;
    }

    button[type="submit"] {
      background-color: #2196F3;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 10px 20px;
      cursor: pointer;
    }

    button[type="submit"]:hover {
      background-color: #0b7dda;
    }

    /* Responsive design */
    @media (max-width: 600px) {
      body {
        font-size: 14px;
      }

      h1 {
        font-size: 20px;
      }

      table {
        font-size: 12px;
      }

      button {
        padding: 6px 10px;
      }
    }

    /* Styles for search bar */
    .search-bar {
      margin-bottom: 20px;
      text-align: center;
    }

    .search-bar input {
      width: 80%;
      padding: 8px;
      font-size: 16px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="search-bar">
      <input type="text" id="searchInput" placeholder="Search for users..." onkeyup="filterUsers()">
    </div>
    <br><br>
    <div class="user-details">
      <table id="userTable">
        <thead>
          <tr>
            <th>Full Name</th>
            <th>Email</th>
            <th>Class</th>
            <th>Contact Number</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <!-- User data will be dynamically inserted here -->
        </tbody>
      </table>
      <a href="https://console.firebase.google.com/u/0/project/noteswift-login/authentication/users">Click here to delete users</a> <br><br>
      <button onclick="exportToExcel()">Download as Excel file</button>
    </div>
  </div>

  <!-- Import Firebase SDK using script tags -->
  <!-- Firebase Scripts -->
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>

  <script>
    // Firebase configuration
    var firebaseConfig = {
      apiKey: "AIzaSyBiVc598fJn7WmgGVivUvZyKRBNfrug75U",
      authDomain: "noteswift-login.firebaseapp.com",
      projectId: "noteswift-login",
      storageBucket: "noteswift-login.appspot.com",
      messagingSenderId: "227729152808",
      appId: "1:227729152808:web:445ffda231ae7baf8a4e1d",
      measurementId: "G-Y3GZ6HDWF4"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // Reference to the 'users' node in the database
    const usersRef = database.ref('users');

    // Function to retrieve user data and populate the user table
    usersRef.orderByChild('fullName').on('value', function (snapshot) {
      const userTable = document.getElementById('userTable').getElementsByTagName('tbody')[0];
      userTable.innerHTML = ''; // Clear existing table rows

      // Populate the table with user data
      snapshot.forEach(function (childSnapshot) {
        const userData = childSnapshot.val();
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
          <td>${userData.fullName || ''}</td>
          <td>${userData.email || ''}</td>
          <td>${userData.class || ''}</td>
          <td>${userData.contactNumber || ''}</td>
          <td>
            <button class="copy" data-uid="${childSnapshot.key}" onclick="copyUid('${childSnapshot.key}')">Copy UID</button>
          </td>
        `;
        userTable.appendChild(newRow);
      });
    });

    // Function to copy UID to clipboard
    function copyUid(uid) {
      const el = document.createElement('textarea');
      el.value = uid;
      document.body.appendChild(el);
      el.select();
      document.execCommand('copy');
      document.body.removeChild(el);
      alert('UID copied to clipboard: ' + uid);
    }

    // Reference to the 'courses' node in the database
    const coursesRef = database.ref('courses');

    // Function to delete a user from a course
    function deleteUserFromCourse(courseId, uidToDelete) {
      coursesRef.child(courseId).child(uidToDelete).remove()
        .then(() => {
          alert("User deleted from course successfully!");
        })
        .catch(error => {
          console.error("Error deleting user from course: ", error);
          alert("Error deleting user from course. Please try again.");
        });
    }

    // Function to handle delete button click
    function handleDeleteButtonClick(courseId, uidToDelete) {
      if (confirm("Are you sure you want to delete this user from the course?")) {
        deleteUserFromCourse(courseId, uidToDelete);
      }
    }

    // Function to retrieve course data and populate the course table
    coursesRef.on('value', function (snapshot) {
      const courseTable = document.getElementById('courseTable').getElementsByTagName('tbody')[0];
      courseTable.innerHTML = ''; // Clear existing table rows

      snapshot.forEach(function (childSnapshot) {
        const courseId = childSnapshot.key;
        const usersWithAccess = Object.keys(childSnapshot.val() || {});

        let rowspan = usersWithAccess.length > 0 ? usersWithAccess.length : 1;

        usersWithAccess.forEach(function (uid, index) {
          // Create a new table row for each user in the course
          const newRow = document.createElement('tr');
          if (index === 0) {
            newRow.innerHTML = `
          <td rowspan="${rowspan}">${courseId}</td>
          <td>${uid}</td>
          <td><span id="fullName_${courseId}_${uid}"></span></td>
          <td>
            <button class="delete" onclick="handleDeleteButtonClick('${courseId}', '${uid}')">Delete</button>
          </td>
        `;
          } else {
            newRow.innerHTML = `
          <td>${uid}</td>
          <td><span id="fullName_${courseId}_${uid}"></span></td>
          <td>
            <button class="delete" onclick="handleDeleteButton          Click('${courseId}', '${uid}')">Delete</button>
          </td>
        `;
          }
          courseTable.appendChild(newRow);

          // Fetch and display full name for the user
          usersRef.child(uid).once('value').then(function (userSnapshot) {
            const userData = userSnapshot.val();
            const fullName = userData ? userData.fullName || '' : '';
            document.getElementById(`fullName_${courseId}_${uid}`).textContent = fullName;
          });
        });
      });
    });

    // Function to handle form submission
    document.getElementById('courseForm').addEventListener('submit', function (event) {
      event.preventDefault(); // Prevent default form submission

      // Get form values
      const courseId = document.getElementById('courseId').value.trim();
      const addUsers = document.getElementById('addUsers').value.trim() ? document.getElementById('addUsers').value.trim().split(',') : [];

      // Convert full names to UIDs
      const uidsToAdd = [];
      addUsers.forEach(fullName => {
        const uid = getUidFromFullName(fullName.trim());
        if (uid) {
          uidsToAdd.push(uid);
        } else {
          console.error(`No UID found for user with full name: ${fullName}`);
        }
      });

      // Update course data in the database
      coursesRef.child(courseId).transaction(function (courseData) {
        if (courseData === null) {
          courseData = {};
        }
        // Add users to the course data
        uidsToAdd.forEach(uid => {
          courseData[uid] = true;
        });
        return courseData;
      }).then(() => {
        // Alert when course is updated successfully
        alert("Course updated successfully!");
        // Reset form after successful submission
        document.getElementById('courseForm').reset();
      }).catch(error => {
        console.error("Error updating course: ", error);
        alert("Error updating course. Please try again.");
      });
    });

    // Function to get UID from Full Name
    function getUidFromFullName(fullName) {
      let uid = '';
      const userRows = document.getElementById('userTable').getElementsByTagName('tbody')[0].getElementsByTagName('tr');
      for (let i = 0; i < userRows.length; i++) {
        const cells = userRows[i].getElementsByTagName('td');
        if (cells.length >= 1 && cells[0].textContent.trim() === fullName) {
          uid = cells[1].textContent.trim();
          break;
        }
      }
      return uid;
    }

    // Function to export table data to Excel with current date in the file name
    function exportToExcel() {
      // Get the current date
      const currentDate = new Date().toISOString().split('T')[0];

      // Format the file name with the current date
      const filename = `user-details(${currentDate}).xlsx`;

      // Get the table element
      const table = document.getElementById("userTable");

      // Convert the table to a worksheet
      const ws = XLSX.utils.table_to_sheet(table);

      // Create a new workbook
      const wb = XLSX.utils.book_new();

      // Add the worksheet to the workbook
      XLSX.utils.book_append_sheet(wb, ws, "Users");

      // Save the workbook as an Excel file with the specified filename
      XLSX.writeFile(wb, filename);
    }

    // Function to filter users in the table based on search input
    function filterUsers() {
      const input = document.getElementById('searchInput').value.toLowerCase();
      const table = document.getElementById('userTable');
      const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');

      for (let i = 0; i < rows.length; i++) {
        let cells = rows[i].getElementsByTagName('td');
        let match = false;
        for (let j = 0; j < cells.length - 1; j++) { // exclude Actions column
          if (cells[j].textContent.toLowerCase().indexOf(input) > -1) {
            match = true;
            break;
          }
        }
        rows[i].style.display = match ? '' : 'none';
      }
    }
  </script>
 <script>
        if ('serviceWorker' in navigator) {
          navigator.serviceWorker.register('/service-worker.js')
            .then((registration) => {
              console.log('Service Worker registered with scope:', registration.scope);
            })
            .catch((error) => {
              console.error('Service Worker registration failed:', error);
            });
        }
      </script>
   <script src="js/gt.min.js" data-gt-widget-id="43217984"></script>
</body>


</html>

